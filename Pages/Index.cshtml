@page
@model IndexModel
@{
    ViewData["Title"] = "Azure WAF 規則掃描器"; // 頁面標題。
}

<div class="text-center">
    <h1 class="display-4">Azure WAF 規則掃描器</h1>
    <p>掃描所有可存取的 Azure 訂閱中的 Web 應用程式防火牆 (WAF) 策略和規則。</p>
</div>

<hr />

<div class="container mt-4">
    <form method="post">
        <div class="row mb-3 align-items-end">
            <div class="col-md-4">
                <label for="SelectedTenantId" class="form-label">選擇租用戶:</label>
                <select asp-for="SelectedTenantId" asp-items="Model.AvailableTenants"
                        class="form-select" onchange="document.getElementById('selectTenantButton').click();">
                </select>
                <button type="submit" id="selectTenantButton" asp-page-handler="SelectTenant" style="display:none;"></button>
            </div>
            <div class="col-md-4">
                @if (Model.IsTenantSelected)
                {
                    <label for="SelectedSubscriptionId" class="form-label">選擇訂閱:</label>
                    <select asp-for="SelectedSubscriptionId" asp-items="Model.AvailableSubscriptions"
                            class="form-select" onchange="document.getElementById('selectSubscriptionButton').click();">
                    </select>
                    <button type="submit" id="selectSubscriptionButton" asp-page-handler="SelectSubscription" style="display:none;"></button>
                }
                else
                {
                    <label for="SelectedSubscriptionId" class="form-label text-muted">選擇訂閱:</label>
                    <select class="form-select" disabled>
                        <option>--- 請先選擇租用戶 ---</option>
                    </select>
                }
            </div>
            <div class="col-md-4">
                @if (Model.IsSubscriptionSelected)
                {
                    <label for="SelectedResourceGroupName" class="form-label">選擇資源群組:</label>
                    <select asp-for="SelectedResourceGroupName" asp-items="Model.AvailableResourceGroups"
                            class="form-select" onchange="document.getElementById('selectResourceGroupButton').click();">
                    </select>
                    <button type="submit" id="selectResourceGroupButton" asp-page-handler="SelectResourceGroup" style="display:none;"></button>
                }
                else
                {
                    <label for="SelectedResourceGroupName" class="form-label text-muted">選擇資源群組:</label>
                    <select class="form-select" disabled>
                        <option>--- 請先選擇訂閱 ---</option>
                    </select>
                }
            </div>
        </div>
    </form>
</div>

<hr />

<!-- 錯誤訊息顯示區塊 -->
@if (Model.ScanErrorOccurred)
{
    <div class="alert alert-danger mt-3" role="alert">
        掃描 Azure WAF 策略時發生錯誤。請檢查您的權限設定以及後台日誌。
    </div>
}

<!-- 掃描結果顯示區塊 -->
@if (Model.WafPolicies != null && Model.WafPolicies.Any())
{
    <h2 class="mt-4">掃描結果 (@Model.WafPolicies.Count 個策略):</h2>

    <!-- 遍歷並顯示每個 WAF 策略的詳細資訊。
         結果會根據訂閱名稱、資源群組名稱和策略名稱進行排序，以便於查看。 -->
    @foreach (var policy in Model.WafPolicies.OrderBy(p => p.SubscriptionName).ThenBy(p => p.ResourceGroupName).ThenBy(p => p.Name))
    {
        <div class="card mt-3">
            <div class="card-header bg-info text-white">
                <h3 class="mb-0">
                    @policy.Name
                    <small class="float-end">(@policy.Type)</small>
                </h3>
            </div>
            <div class="card-body">
                <p><strong>訂閱:</strong> @policy.SubscriptionName (@policy.SubscriptionId)</p>
                <p><strong>資源群組:</strong> @policy.ResourceGroupName</p>
                @if (!string.IsNullOrEmpty(policy.AssociatedResource) && policy.AssociatedResource != "N/A (Linked to Front Door instance)")
                {
                    <p><strong>關聯資源:</strong> @policy.AssociatedResource</p>
                }

                <!-- 託管規則集顯示區塊 -->
                <h4 class="mt-3">託管規則集:</h4>
                @if (policy.ManagedRules.Any())
                {
                    <ul class="list-group list-group-flush">
                        @foreach (var managedRuleSet in policy.ManagedRules)
                        {
                            <li class="list-group-item">
                                <strong>類型:</strong> @managedRuleSet.RuleSetType, <strong>版本:</strong> @managedRuleSet.RuleSetVersion
                                @if (managedRuleSet.RuleGroupOverrides.Any())
                                {
                                    <ul class="list-group list-group-flush mt-2">
                                        @foreach (var groupOverride in managedRuleSet.RuleGroupOverrides)
                                        {
                                            <li class="list-group-item list-group-item-light">
                                                <strong>群組:</strong> @groupOverride.RuleGroupName
                                                @if (groupOverride.DisabledRules.Any())
                                                {
                                                    <span class="badge bg-warning text-dark ms-2">已禁用規則: @string.Join(", ", groupOverride.DisabledRules)</span>
                                                }
                                                else
                                                {
                                                    <span class="badge bg-success ms-2">無禁用規則</span>
                                                }
                                            </li>
                                        }
                                    </ul>
                                }
                                else
                                {
                                    <p class="text-muted">此託管規則集無特定群組覆寫。</p>
                                }
                            </li>
                        }
                    </ul>
                }
                else
                {
                    <p class="text-muted">無託管規則集。</p>
                }

                <!-- 自訂規則顯示區塊 -->
                <h4 class="mt-3">自訂規則:</h4>
                @if (policy.CustomRules.Any())
                {
                    <ul class="list-group list-group-flush">
                        @foreach (var customRule in policy.CustomRules)
                        {
                            <li class="list-group-item">
                                <strong>名稱:</strong> @customRule.Name, <strong>優先順序:</strong> @customRule.Priority, <strong>動作:</strong> @customRule.Action (@customRule.RuleType)
                                @if (customRule.MatchConditions.Any())
                                {
                                    <ul class="list-group list-group-flush mt-2">
                                        @foreach (var mc in customRule.MatchConditions)
                                        {
                                            <li class="list-group-item list-group-item-secondary">
                                                <strong>匹配變數:</strong> @mc.MatchVariable
                                                @if (!string.IsNullOrEmpty(mc.Selector))
                                                {
                                                    <span> (選擇器: @mc.Selector)</span>
                                                }
                                                , <strong>運算子:</strong> @mc.Operator
                                                @if (mc.MatchValues.Any())
                                                {
                                                    <span>, <strong>值:</strong> @string.Join(", ", mc.MatchValues)</span>
                                                }
                                                @if (mc.Transforms.Any())
                                                {
                                                    <span>, <strong>轉換:</strong> @string.Join(", ", mc.Transforms)</span>
                                                }
                                            </li>
                                        }
                                    </ul>
                                }
                            </li>
                        }
                    </ul>
                }
                else
                {
                    <p class="text-muted">無自訂規則。</p>
                }

                <!-- 排除項顯示區塊 (現在包含更詳細的 Front Door 排除項解析) -->
                @if (policy.Exclusions.Any())
                {
                    <h4 class="mt-3">排除項:</h4>
                    <ul class="list-group list-group-flush">
                        @foreach (var exclusion in policy.Exclusions)
                        {
                            <li class="list-group-item">
                                <strong>變數:</strong> @exclusion.MatchVariable, <strong>操作符:</strong> @exclusion.SelectorMatchOperator, <strong>選擇器:</strong> @exclusion.Selector
                                @if (exclusion.ManagedRuleSetExclusions.Any())
                                {
                                    <h6 class="mt-2">針對託管規則集的排除:</h6>
                                    <ul class="list-group list-group-flush">
                                        @foreach (var mrsExclusion in exclusion.ManagedRuleSetExclusions)
                                        {
                                            <li class="list-group-item list-group-item-info">
                                                <strong>規則集:</strong> @mrsExclusion.RuleSetType @mrsExclusion.RuleSetVersion
                                                @if (mrsExclusion.RuleGroupExclusions.Any())
                                                {
                                                    <h6 class="mt-2">針對規則群組的排除:</h6>
                                                    <ul class="list-group list-group-flush">
                                                        @foreach (var rgExclusion in mrsExclusion.RuleGroupExclusions)
                                                        {
                                                            <li class="list-group-item list-group-item-light">
                                                                <strong>群組:</strong> @rgExclusion.RuleGroupName
                                                                @if (rgExclusion.Rules.Any())
                                                                {
                                                                    <span> (規則 ID: @string.Join(", ", rgExclusion.Rules.Select(r => r.RuleId)))</span>
                                                                }
                                                            </li>
                                                        }
                                                    </ul>
                                                }
                                            </li>
                                        }
                                    </ul>
                                }
                            </li>
                        }
                    </ul>
                }
                else
                {
                    <p class="text-muted mt-3">無排除項。</p>
                }
            </div>
        </div>
    }
}
else if (!Model.ScanErrorOccurred && Model.IsTenantSelected) // 只有當選擇了租用戶但沒有找到 WAF 策略時才顯示此訊息
{
    <div class="alert alert-info mt-3" role="alert">
        在所選租用戶 @(string.IsNullOrEmpty(Model.SelectedSubscriptionId) ? "中 (所有訂閱)" : $"的訂閱 '{Model.SelectedSubscriptionId}'") @(string.IsNullOrEmpty(Model.SelectedResourceGroupName) ? "中" : $"的資源群組 '{Model.SelectedResourceGroupName}' 中") 沒有找到任何 Azure WAF 策略。請確保您的權限設定正確，並且該租用戶/訂閱/資源群組中存在 Front Door WAF 策略。
    </div>
}
else if (!Model.IsTenantSelected)
{
    <div class="alert alert-info mt-3" role="alert">
        請從上方下拉選單中選擇一個 Azure AD 租用戶以開始掃描 WAF 策略。
    </div>
}
